<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebSocket Test - ApiMyChat</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: "Segoe UI", Tahoma, Arial, sans-serif; margin: 24px; background: #f7f7fb; color: #222; }
    .card { background: #fff; border: 1px solid #e3e3ee; border-radius: 8px; padding: 16px; max-width: 900px; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    label { display: block; font-size: 12px; color: #555; margin-top: 8px; }
    input, select, button, textarea { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #cfcfe0; border-radius: 6px; box-sizing: border-box; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .actions { display: flex; gap: 8px; margin-top: 12px; }
    .actions button { width: auto; }
    .chat { margin-top: 12px; border: 1px solid #d9d9e8; border-radius: 8px; background: #fafafe; height: 320px; overflow-y: auto; padding: 10px; }
    .msg { max-width: 80%; margin: 8px 0; padding: 8px 10px; border-radius: 10px; background: #fff; border: 1px solid #e5e5f2; }
    .msg.mine { margin-left: auto; background: #e8f6ff; border-color: #bde6ff; }
    .msg-head { display: flex; justify-content: space-between; gap: 8px; font-size: 11px; color: #5a5a6d; margin-bottom: 4px; }
    .msg-content { font-size: 13px; line-height: 1.35; white-space: pre-wrap; word-break: break-word; }
    .log { margin-top: 12px; background: #0f1020; color: #e7e7f5; padding: 10px; border-radius: 6px; height: 260px; overflow: auto; font-family: Consolas, monospace; font-size: 12px; }
    .status { font-size: 12px; color: #444; margin-top: 8px; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 11px; background: #eee; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Teste WebSocket - ApiMyChat</h1>

    <div class="row">
      <div>
        <label>URL base do WS</label>
        <input id="wsBase" value="ws://localhost:8000/ws/connect" />
      </div>
      <div>
        <label>Dev bypass</label>
        <select id="devBypass">
          <option value="1">Sim (dev=1)</option>
          <option value="0">Não</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>User ID (ou token JWT)</label>
        <input id="userId" placeholder="ex: 123" />
      </div>
      <div>
        <label>Room ID</label>
        <input id="roomId" placeholder="ex: sala-abc" />
      </div>
    </div>

    <label>Chat</label>
    <div id="chat" class="chat"></div>

    <div class="actions">
      <button id="connectBtn">Conectar</button>
      <button id="disconnectBtn" disabled>Desconectar</button>
    </div>

    <label>Mensagem</label>
    <textarea id="message" rows="3" placeholder="Digite a mensagem..."></textarea>

    <div class="actions">
      <button id="sendBtn" disabled>Enviar via WS</button>
      <button id="sendHttpBtn">Enviar via HTTP (/ws/message)</button>
      <input id="historyLimit" type="number" min="1" value="50" style="width:90px" />
      <button id="fetchMessagesBtn">Carregar histórico (/messages)</button>
      <button id="clearBtn">Limpar log</button>
    </div>

    <div class="status">
      Status: <span id="status" class="badge">desconectado</span>
    </div>

    <div id="log" class="log"></div>
  </div>

<script>
  const el = (id) => document.getElementById(id);
  const logBox = el('log');
  const chatBox = el('chat');
  let socket = null;
  const userNameCache = {};

  function log(msg) {
    const time = new Date().toLocaleTimeString();
    logBox.textContent += `[${time}] ${msg}\n`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  function setStatus(text) {
    el('status').textContent = text;
  }

  function getApiBase() {
    return el('wsBase').value.trim().replace(/^ws/, 'http');
  }

  function toTime(value) {
    if (!value) return new Date().toLocaleTimeString();
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return String(value);
    return date.toLocaleTimeString();
  }

  function normalizeMessage(raw) {
    if (!raw) return null;
    if (typeof raw === 'string') {
      return {
        sender: 'sistema',
        content: raw,
        when: new Date().toISOString()
      };
    }
    return {
      sender: raw.senderId || raw.sender_id || raw.userId || raw.user_id || 'desconhecido',
      content: raw.content || raw.message || '',
      when: raw.createdAt || raw.created_at || new Date().toISOString()
    };
  }

  async function resolveUserName(userID) {
    if (!userID) return 'desconhecido';
    if (userNameCache[userID]) return userNameCache[userID];

    const base = getApiBase();
    const url = base.replace('/ws/connect', `/GetUserByID/${encodeURIComponent(userID)}`);
    try {
      const res = await fetch(url);
      if (!res.ok) {
        userNameCache[userID] = userID;
        return userID;
      }
      const data = await res.json();
      const name = data.name || data.Name || userID;
      userNameCache[userID] = name;
      return name;
    } catch (_) {
      userNameCache[userID] = userID;
      return userID;
    }
  }

  async function addChatMessage(raw) {
    const msg = normalizeMessage(raw);
    if (!msg || !msg.content) return;

    const mine = msg.sender === el('userId').value.trim();
    const senderLabel = mine ? 'Você' : await resolveUserName(msg.sender);
    const row = document.createElement('div');
    row.className = `msg${mine ? ' mine' : ''}`;

    const head = document.createElement('div');
    head.className = 'msg-head';
    const sender = document.createElement('span');
    sender.textContent = senderLabel;
    const when = document.createElement('span');
    when.textContent = toTime(msg.when);
    head.appendChild(sender);
    head.appendChild(when);

    const content = document.createElement('div');
    content.className = 'msg-content';
    content.textContent = msg.content;

    row.appendChild(head);
    row.appendChild(content);
    chatBox.appendChild(row);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function buildWsUrl() {
    const base = el('wsBase').value.trim();
    const id = encodeURIComponent(el('userId').value.trim());
    const room = encodeURIComponent(el('roomId').value.trim());
    const dev = el('devBypass').value;
    const sep = base.includes('?') ? '&' : '?';
    return `${base}${sep}id=${id}&room=${room}&dev=${dev}`;
  }

  el('connectBtn').addEventListener('click', () => {
    const id = el('userId').value.trim();
    const room = el('roomId').value.trim();
    if (!id || !room) {
      log('Preencha userId e roomId.');
      return;
    }

    const url = buildWsUrl();
    socket = new WebSocket(url);

    socket.addEventListener('open', () => {
      setStatus('conectado');
      el('connectBtn').disabled = true;
      el('disconnectBtn').disabled = false;
      el('sendBtn').disabled = false;
      log(`Conectado em ${url}`);
    });

    socket.addEventListener('message', (event) => {
      log(`Recebido: ${event.data}`);
      try {
        const parsed = JSON.parse(event.data);
        void addChatMessage(parsed);
      } catch (_) {
        void addChatMessage(event.data);
      }
    });

    socket.addEventListener('close', () => {
      setStatus('desconectado');
      el('connectBtn').disabled = false;
      el('disconnectBtn').disabled = true;
      el('sendBtn').disabled = true;
      log('Conexão encerrada.');
    });

    socket.addEventListener('error', (err) => {
      log(`Erro WS: ${err}`);
    });
  });

  el('disconnectBtn').addEventListener('click', () => {
    if (socket) socket.close();
  });

  el('sendBtn').addEventListener('click', () => {
    const msg = el('message').value.trim();
    if (!msg) return;
    if (!socket || socket.readyState !== WebSocket.OPEN) {
      log('WS não está conectado.');
      return;
    }
    socket.send(msg);
    log(`Enviado (WS): ${msg}`);
  });

  el('sendHttpBtn').addEventListener('click', async () => {
    const id = el('userId').value.trim();
    const room = el('roomId').value.trim();
    const msg = el('message').value.trim();
    if (!id || !room || !msg) {
      log('Preencha userId, roomId e mensagem.');
      return;
    }

    const base = getApiBase();
    const url = base.replace('/ws/connect', '/ws/message') + `?id=${encodeURIComponent(id)}&dev=${el('devBypass').value}`;

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Dev-Bypass': el('devBypass').value },
        body: JSON.stringify({ room, content: msg })
      });
      const text = await res.text();
      log(`HTTP ${res.status}: ${text}`);
    } catch (e) {
      log(`Erro HTTP: ${e.message}`);
    }
  });

  el('fetchMessagesBtn').addEventListener('click', async () => {
    const room = el('roomId').value.trim();
    if (!room) {
      log('Preencha roomId para buscar mensagens.');
      return;
    }

    const limitRaw = el('historyLimit').value.trim();
    const limit = Number(limitRaw) > 0 ? Number(limitRaw) : 50;
    const base = getApiBase();
    const url = base.replace('/ws/connect', '/messages') +
      `?room=${encodeURIComponent(room)}&limit=${encodeURIComponent(limit)}`;

    try {
      const res = await fetch(url);
      const text = await res.text();
      if (!res.ok) {
        log(`Get messages HTTP ${res.status}: ${text}`);
        return;
      }

      let items = [];
      try {
        items = JSON.parse(text);
      } catch (_) {
        log(`Resposta inválida: ${text}`);
        return;
      }

      log(`Histórico carregado: ${items.length} mensagens`);
      chatBox.innerHTML = '';
      const ordered = [...items].reverse();
      for (const msg of ordered) {
        await addChatMessage(msg);
        const when = msg.createdAt || msg.created_at || '';
        const senderID = msg.senderId || msg.sender_id;
        const senderName = await resolveUserName(senderID);
        log(`[history] ${when} ${senderName}: ${msg.content}`);
      }
    } catch (e) {
      log(`Erro ao buscar mensagens: ${e.message}`);
    }
  });

  el('clearBtn').addEventListener('click', () => {
    logBox.textContent = '';
    chatBox.innerHTML = '';
  });
</script>
</body>
</html>
